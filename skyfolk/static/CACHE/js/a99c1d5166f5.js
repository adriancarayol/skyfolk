$(document).ready(function(){$('select').material_select();$('ul.tabs').tabs();$('#btn-upload-photo').on('click',function(){$('#upload_photo').toggle();});$('#close_upload_form, #close_upload_zip_form').on('click',function(){$('#upload_photo').toggle();});$('#del-photo').click(AJAX_delete_photo);$("#edit-photo").click(function(){$(this).text(function(i,text){return text==="Editar"?"No editar":"Editar";});$('#wrapper-edit-form').toggle();return false;});$('.tags-content').on('click','blockquote',function(){$(this).nextAll('input').click();});$('#crop-image').on('click',function(){$('#crop-image-preview').show();$('.avatar-form .is-cutted').val('true');});$('#crop-image-preview').find('.close-crop-image').on('click',function(){$('#crop-image-preview').hide();$('.avatar-form .is-cutted').val('false');});$('#crop-image-preview').find('#cut-done').on('click',function(){$('#crop-image-preview').hide();$('.avatar-form .is-cutted').val('true');});$(this).on('keydown',function(e){var key=e.keyCode||e.which;if(key==27){$('#upload_photo').hide();$('#crop-image-preview').hide();$('.avatar-form .is-cutted').val('false');}});});function AJAX_delete_photo(){var _id=$('.photo-body').attr('data-id');$.ajax({url:'/delete/photo/',type:'DELETE',data:{'id':_id,'csrfmiddlewaretoken':csrftoken},dataType:'json',success:function(json){swal({title:"Photo was deleted.",text:json.msg,timer:2500,showConfirmButton:true},function(){window.location.replace('/multimedia/'+json.author+'/');});},error:function(rs,e){swal(rs.responseText+" "+e);}});}
$(document).ready(function(){$('#tab-messages').find('.wrapper').each(function(){var showLimitChar=90;var comment=$(this).find('.wrp-comment');var text=comment.text();var show=$(this).find('.show-more a');text=text.replace(/\s\s+/g,' ');if(text.length<showLimitChar){$(show).css('display','none');}});$("#tab-messages").on('click','.show-more a',function(){var $this=$(this);var $content=$this.parent().prev("div.comment").find(".wrp-comment");var linkText=$this.text().toUpperCase();if(linkText==="+ MOSTRAR MÁS"){linkText="- Mostrar menos";$content.css('height','auto');}else{linkText="+ Mostrar más";$content.css('height','2.6em');}
$this.text(linkText);return false;});$('.fa-expand').on('click',function(){var caja_pub=$(this).closest('.wrapper');expandComment(caja_pub);});function expandComment(caja_pub){var id_pub=$(caja_pub).attr('id').split('-')[1];var commentToExpand=document.getElementById('expand-'+id_pub);$(commentToExpand).fadeToggle("fast");}
$('.cerrar_ampliado').on('click',function(){var expand=$(this).closest('.ampliado');closeExpand(expand);});function closeExpand(expand){var c=$(expand).attr('id').split('-')[1];var toClose=document.getElementById('expand-'+c);$(toClose).hide();}});var UTILS=UTILS||(function(){var _args={};var _showLimitChar=90;return{init:function(args){_args=args;},conn_socket:function(){var ws_scheme=window.location.protocol=="https:"?"wss":"ws";var ws_path=ws_scheme+'://'+window.location.host+window.location.pathname+"stream/";console.log("Connecting to "+ws_path);var socket=new ReconnectingWebSocket(ws_path);socket.onmessage=function(message){console.log("Got message "+message.data);var data=JSON.parse(message.data);if(data.type==="pub"){var content="";content+='<div class="row">';content+='<div class="col s12">';if(data.level>0){content+=' <div class="col s12 wrapper" id="pub-'+data.id+'" data-id="'+_args+'" style="min-width: 98% !important; border-right: 3px solid #1e88e5;">';}else
content+=' <div class=\"col s12 wrapper\" id="pub-'+data.id+'" data-id="'+_args+'">';content+="            <div class=\"box\">";content+='            <span id="check-'+data.id+'" class=\"top-options zoom-pub tooltipped\" data-position=\"bottom\" data-delay=\"50\" data-tooltip=\"Ver conversación completa\"><i class=\"fa fa-plus-square-o\" aria-hidden=\"true\"><\/i><\/span>';if(_args==data.author_id&&(data.event_type==1||data.event_type==3)){content+='            <span data-id="'+data.id+'" id=\"edit-comment-content\" class=\"top-options edit-comment tooltipped\" data-position=\"bottom\" data-delay=\"50\" data-tooltip=\"Editar comentario\"><i class=\"fa fa-pencil\" aria-hidden=\"true\"><\/i><\/span>';}
content+='<div class="row">';content+="                <div class=\"articulo col s12\">";content+='<div class="row">';if(_args==data.author_id){content+="      <div class=\"image col l1 m2 s2\" style=\"box-shadow: 0 1px 5px rgba(129, 199, 132, 1);\">";}else{content+="      <div class=\"image col l1 m2 s2\">";}
content+='        <div class="usr-img img-responsive"><img src="'+data.avatar_path+'" alt="'+data.author_username+'" width="120" height="120"></div>';content+="      </div>";content+='<div class="col l10 m12 s9">';content+='                  <h2 class="h22"><a href="/profile/'+data.author_username+'" >@'+data.author_username+'</a>';if(data.parent){content+='<span class="chip">';content+='<img src="'+data.parent_avatar+'" alt="'+data.author_parent+'">';content+='<i class="fa fa-reply"></i> <a href="/profile/'+data.parent_author+'">@'+data.parent_author+'</a>';content+='</span>';}
content+='</h2>';content+='                    <p id="pub-created" class="blue-text text-darken-2">'+data.created+'<\/p><br>';content+='<div class="row publication-content">';content+="                  <div class=\"parrafo comment\">";content+='                      <div class="wrp-comment">'+data.content+'<\/div>';content+="                  </div>";content+='                    <div class="show-more" id="show-comment-'+data.id+'">';content+="                        <a href=\"#\">+ Mostrar más<\/a>";content+="                    </div>";content+="                    </div>";if(data.extra_content){content+='<div class="card small">';content+='<div class="card-image">';if(data.extra_content_image){content+='<img src="'+data.extra_content_image+'">';}else{content+='<img src="/static/dist/img/nuevo_back.png">';}
content+='<span class="card-title white-text">'+data.extra_content_title+'</span>';content+='</div>';content+='<div class="card-content">';content+='<p>'+data.extra_content_description+'</p>';content+='</div>';content+='<div class="card-action">';content+='<a href="'+data.extra_content_url+'">Ver</a>';content+='</div></div>';}
if(data.images!==undefined&&data.images.length>0){content+='<div class="row images">';for(var image=0;image<data.images.length;image++){content+='<div class="col s4 z-depth-2">';content+='<img class="responsive-img" src="/media/'+data.images[image].image+'" alt="Imagen de: '+data.author_username+'" title="Imagen de: '+data.author_username+'">';content+="                    </div>";}
content+="                    </div>";}
content+="                    </div>";content+="                    </div>";content+="                    </div>";content+="                    </div>";content+='<div class="row">';content+='<div class="divider"></div>';content+="                <div class=\"options_comentarios\" id=\"options-comments\">";content+="                    <ul class=\"opciones\">";if(_args==data.board_owner_id||data.author_id==_args){content+="                             <li class=\"trash-comment\" title=\"Borrar comentario\"><i class=\"fa fa-trash\"><\/i><\/li>";}
if(_args!=data.author_id){content+="                            <li title=\"No me gusta\" class=\"hate-comment\" id=\"fa-hate\">";content+='                                <i class="fa fa-angle-down" aria-hidden="true"></i>';content+='                                <i class="fa hate-value"></i>';content+="                            </li>";content+='                        <li id="like-heart" title="¡Me gusta!" class="like-comment"><i class="fa fa-angle-up" aria-hidden="true"></i><i id="like-value" class="fa"></i></li>';}
content+='                       <li title=\"Añadir a mi skyline\" data-id="'+data.id+'" class=\"add-timeline\" id=\"add_to_skyline\"><i class=\"fa fa-quote-right\" aria-hidden=\"true\"> <\/i><\/li>';content+='                       <li title="Responder" class="reply-comment"><i class="fa fa-reply" id="reply-caja-comentario-'+data.id+'"><\/i><\/li>';content+="                    </ul>";content+="                </div>";content+="                </div>";content+="    </div>";if(_args==data.author_id){content+='<div data-user-id="'+data.author_id+'" id="author-controls-'+data.id+'" class="author-controls">';content+='<div class="row">';content+='<div class="col s12">';content+='<form method="post" accept-charset="utf-8">';content+='<input type="hidden" name="csrfmiddlewaretoken" value="'+data.token+'">';content+='<div class="row">';content+='<div class="input-field col s12">';content+='<i class="material-icons prefix">create</i>';content+='<textarea class="materialize-textarea" placeholder="Escribe el contenido del nuevo mensaje" id="id_caption-'+data.id+'" cols="40" maxlength="500" name="content" rows="10" required="required" style="height: 10.9969px;"></textarea>';content+='<label for="id_caption-'+data.id+'">Editar comentario</label></div>';content+='<div class="row">';content+='<button data-id="'+data.id+'" class="waves-effect waves-light btn blue darken-1 right edit-comment-btn" type="button" id="submit_edit_publication">Editar<i class="material-icons right">mode_edit</i></button>';content+='</div></div></form></div></div></div>';}
content+='<div class="wrapper-reply">';content+='<div class="hidden" id="caja-comentario-'+data.id+'">';content+='<form class="reply-form" action="" method="post">';content+='<input type="hidden" name="csrfmiddlewaretoken" value="'+data.token+'">';content+='<input id="id_author" name="author" type="hidden" value="'+_args+'">';content+='<input id="id_board_owner" name="board_owner" type="hidden" value="'+data.board_owner_id+'">';content+='<input id="id_parent" name="parent" type="hidden">';content+='<div class="row">';content+='<div class="col s12">';content+='<div class="row">';content+='<div class="input-field col s12">';content+='<textarea class="materialize-textarea message-reply" id="message-reply-'+data.id+'" cols="40" maxlength="500" name="content" placeholder="Responder a @'+data.author_username+'" rows="10" required=""></textarea>';content+='<label for="message-reply-'+data.id+'">Escribe tu mensaje aqui...</label>';content+='</div>';content+='<div class="file-field input-field col s12">';content+='<div class="btn">';content+='<span>Imágenes</span>';content+='<input id="id_image_reply" name="image" type="file" multiple>';content+='</div>';content+='<div class="file-path-wrapper">';content+='<input class="file-path validate" type="text" placeholder="Upload one or more files">';content+='</div></div></div></div></div>';content+='<button type="button" id="reply-'+data.id+'" class="waves-effect waves-light btn right blue enviar">Enviar<i class="material-icons right">send</i></button>';content+='</form></div></div>';content+="    </div></div></div>";var existing=$('#pub-'+data.id);var no_comments=$('#without-comments');var comment_length=data.content.replace(/\s\s+/g,' ');if(existing.length){existing.html(content);}else{$("#messages-wrapper").prepend(content);}
var show=$('div#pub-'+data.id+'').find('#show-comment-'+data.id+'');if($(no_comments).is(':visible')){$(no_comments).fadeOut();}
if(comment_length.length<_showLimitChar){$(show).css('display','none');}}
else{var content="";content+="                <div class=\"wrapper-reply\">";content+="";content+="";content+="                <div class=\"comment-reply\">";content+='                <div class=\"avatar-reply\"><img src="'+data.avatar_path+'" alt="'+data.author_username+'" width="120" height="120"><\/div>';content+="                    <div class=\"author-reply\">";content+='                      <a href="/profile/'+data.author_username+'">'+data.author_username+'</a>';content+='                      <i class="reply-created">'+data.created+'<\/i>';content+="                    </div>";content+='                      <div class="content-reply">'+data.content+'</div>';content+="                </div>";content+="";content+="                </div>";content+="    </div>";var pub=$('#pub-'+data.parent);$(pub).append(content);}};if(socket.readyState==WebSocket.OPEN)socket.onopen();socket.onclose=function(){console.log("No connected.");};}};}());!function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof module&&module.exports?module.exports=b():a.ReconnectingWebSocket=b()}(this,function(){function a(b,c,d){function l(a,b){var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,!1,!1,b),c}var e={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};d||(d={});for(var f in e)this[f]="undefined"!=typeof d[f]?d[f]:e[f];this.url=b,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var h,g=this,i=!1,j=!1,k=document.createElement("div");k.addEventListener("open",function(a){g.onopen(a)}),k.addEventListener("close",function(a){g.onclose(a)}),k.addEventListener("connecting",function(a){g.onconnecting(a)}),k.addEventListener("message",function(a){g.onmessage(a)}),k.addEventListener("error",function(a){g.onerror(a)}),this.addEventListener=k.addEventListener.bind(k),this.removeEventListener=k.removeEventListener.bind(k),this.dispatchEvent=k.dispatchEvent.bind(k),this.open=function(b){h=new WebSocket(g.url,c||[]),b||k.dispatchEvent(l("connecting")),(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",g.url);var d=h,e=setTimeout(function(){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",g.url),j=!0,d.close(),j=!1},g.timeoutInterval);h.onopen=function(){clearTimeout(e),(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onopen",g.url),g.protocol=h.protocol,g.readyState=WebSocket.OPEN,g.reconnectAttempts=0;var d=l("open");d.isReconnect=b,b=!1,k.dispatchEvent(d)},h.onclose=function(c){if(clearTimeout(e),h=null,i)g.readyState=WebSocket.CLOSED,k.dispatchEvent(l("close"));else{g.readyState=WebSocket.CONNECTING;var d=l("connecting");d.code=c.code,d.reason=c.reason,d.wasClean=c.wasClean,k.dispatchEvent(d),b||j||((g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onclose",g.url),k.dispatchEvent(l("close")));var e=g.reconnectInterval*Math.pow(g.reconnectDecay,g.reconnectAttempts);setTimeout(function(){g.reconnectAttempts++,g.open(!0)},e>g.maxReconnectInterval?g.maxReconnectInterval:e)}},h.onmessage=function(b){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",g.url,b.data);var c=l("message");c.data=b.data,k.dispatchEvent(c)},h.onerror=function(b){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onerror",g.url,b),k.dispatchEvent(l("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(b){if(h)return(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","send",g.url,b),h.send(b);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(a,b){"undefined"==typeof a&&(a=1e3),i=!0,h&&h.close(a,b)},this.refresh=function(){h&&h.close()}}return a.prototype.onopen=function(){},a.prototype.onclose=function(){},a.prototype.onconnecting=function(){},a.prototype.onmessage=function(){},a.prototype.onerror=function(){},a.debugAll=!1,a.CONNECTING=WebSocket.CONNECTING,a.OPEN=WebSocket.OPEN,a.CLOSING=WebSocket.CLOSING,a.CLOSED=WebSocket.CLOSED,a});